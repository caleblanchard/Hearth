// This is your Prisma schema file for Hearth - Household ERP
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE MODELS - Family & Members
// ============================================

model Family {
  id        String   @id @default(uuid())
  name      String
  timezone  String   @default("America/New_York")
  location  String?  // City, State or address for display
  latitude  Float?   // For weather API
  longitude Float?   // For weather API
  settings  Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members                FamilyMember[]
  moduleConfigurations   ModuleConfiguration[]
  auditLogs              AuditLog[]
  choreDefinitions       ChoreDefinition[]
  todoItems              TodoItem[]
  shoppingLists          ShoppingList[]
  calendarEvents         CalendarEvent[]
  guestInvites           GuestInvite[]
  fileUploads            FileUpload[]
  rewardItems            RewardItem[]
  leaderboardEntries     LeaderboardEntry[]
  routines               Routine[]
  communicationPosts     CommunicationPost[]
  mealPlans              MealPlan[]
  leftovers              Leftover[]
  recipes                Recipe[]
  pets                   Pet[]
  inventoryItems         InventoryItem[]
  maintenanceItems       MaintenanceItem[]
  transportSchedules     TransportSchedule[]
  transportLocations     TransportLocation[]
  transportDrivers       TransportDriver[]
  carpoolGroups          CarpoolGroup[]
  documents              Document[]
  kioskSessions          KioskSession[]
  kioskSettings          KioskSettings?
  automationRules        AutomationRule[]
  projects               Project[]

  @@map("families")
}

enum Role {
  PARENT
  CHILD
  GUEST
}

model FamilyMember {
  id           String    @id @default(uuid())
  familyId     String
  name         String
  email        String?   @unique
  passwordHash String?   // For parents
  pin          String?   // Hashed, for children
  role         Role
  birthDate    DateTime?
  avatarUrl    String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  // Relations
  family                            Family                    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdTodos                      TodoItem[]                @relation("TodoCreator")
  assignedTodos                     TodoItem[]                @relation("TodoAssignee")
  shoppingItemsRequested            ShoppingItem[]            @relation("ShoppingItemRequester")
  shoppingItemsAdded                ShoppingItem[]            @relation("ShoppingItemAdder")
  shoppingItemsPurchased            ShoppingItem[]            @relation("ShoppingItemPurchaser")
  createdEvents                     CalendarEvent[]           @relation("EventCreator")
  eventAssignments                  CalendarEventAssignment[]
  choreAssignments                  ChoreAssignment[]
  choreInstancesAssigned            ChoreInstance[]           @relation("ChoreAssignedTo")
  choreInstancesCompleted           ChoreInstance[]           @relation("ChoreCompletedBy")
  choreInstancesApproved            ChoreInstance[]           @relation("ChoreApprovedBy")
  screenTimeSettings                ScreenTimeSettings?
  screenTimeBalance                 ScreenTimeBalance?
  screenTimeTransactions            ScreenTimeTransaction[]   @relation("ScreenTimeTransactions")
  screenTimeTransactionsCreated     ScreenTimeTransaction[]   @relation("ScreenTimeTransactionsCreated")
  screenTimeGraceSettings           ScreenTimeGraceSettings?
  gracePeriodLogs                   GracePeriodLog[]
  gracePeriodApprovals              GracePeriodLog[]          @relation("GraceApprover")
  creditBalance                     CreditBalance?
  creditTransactions                CreditTransaction[]
  creditAdjustmentsCreated          CreditTransaction[]       @relation("CreditAdjuster")
  rewardsCreated                    RewardItem[]              @relation("RewardCreator")
  redemptionsRequested              RewardRedemption[]        @relation("RedemptionRequester")
  redemptionsApproved               RewardRedemption[]        @relation("RedemptionApprover")
  redemptionsRejected               RewardRedemption[]        @relation("RedemptionRejecter")
  redemptionsFulfilled              RewardRedemption[]        @relation("RedemptionFulfiller")
  auditLogsCreated                  AuditLog[]
  guestInvitesCreated               GuestInvite[]
  fileUploadsCreated                FileUpload[]
  notifications                     Notification[]
  pushSubscriptions                 PushSubscription[]
  notificationPreference            NotificationPreference?
  achievements                      UserAchievement[]
  streaks                           Streak[]
  leaderboardEntries                LeaderboardEntry[]
  allowanceSchedules                AllowanceSchedule[]
  savingsGoals                      SavingsGoal[]
  budgets                           Budget[]
  routinesAssigned                  Routine[]
  routineCompletions                RoutineCompletion[]
  postsAuthored                     CommunicationPost[]   @relation("PostAuthor")
  postReactions                     PostReaction[]
  leftoversCreated                  Leftover[]
  recipesCreated                    Recipe[]
  recipeRatings                     RecipeRating[]
  petFeedings                       PetFeeding[]
  maintenanceCompletions            MaintenanceCompletion[]
  transportSchedules                TransportSchedule[]
  documentsUploaded                 Document[]
  documentAccessLogs                DocumentAccessLog[]
  medicationSafety                  MedicationSafety[]
  kioskSessionsAsMember             KioskSession[]
  healthEvents                      HealthEvent[]
  temperatureLogs                   TemperatureLog[]
  medicalProfile                    MedicalProfile?
  automationRulesCreated            AutomationRule[]
  projectsCreated                   Project[]         @relation("ProjectCreator")
  projectTasksAssigned              ProjectTask[]

  @@index([familyId])
  @@index([email])
  @@map("family_members")
}

// ============================================
// MODULE CONFIGURATION
// ============================================

enum ModuleId {
  CHORES
  SCREEN_TIME
  CREDITS
  SHOPPING
  CALENDAR
  TODOS
  ROUTINES
  MEAL_PLANNING
  RECIPES
  INVENTORY
  HEALTH
  PROJECTS
  COMMUNICATION
  TRANSPORT
  PETS
  MAINTENANCE
  DOCUMENTS
  FINANCIAL
  LEADERBOARD
  RULES_ENGINE
}

model ModuleConfiguration {
  id         String    @id @default(uuid())
  familyId   String
  moduleId   ModuleId
  isEnabled  Boolean   @default(true)
  enabledAt  DateTime?
  disabledAt DateTime?
  settings   Json?     @default("{}")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, moduleId])
  @@map("module_configurations")
}

// ============================================
// CHORES MODULE
// ============================================

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model ChoreDefinition {
  id               String   @id @default(uuid())
  familyId         String
  name             String
  description      String?
  instructions     String?
  estimatedMinutes Int
  difficulty       Difficulty
  creditValue      Int      @default(0)
  minimumAge       Int?
  iconName         String   @default("task")
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  family    Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  schedules ChoreSchedule[]

  @@index([familyId, isActive])
  @@map("chore_definitions")
}

enum AssignmentType {
  FIXED
  ROTATING
  OPT_IN
}

enum Frequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

model ChoreSchedule {
  id                String         @id @default(uuid())
  choreDefinitionId String
  assignmentType    AssignmentType
  frequency         Frequency
  customCron        String?
  dayOfWeek         Int?           // 0-6, for weekly
  requiresApproval  Boolean        @default(false)
  requiresPhoto     Boolean        @default(false)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  choreDefinition ChoreDefinition   @relation(fields: [choreDefinitionId], references: [id], onDelete: Cascade)
  assignments     ChoreAssignment[]
  instances       ChoreInstance[]

  @@index([choreDefinitionId, isActive])
  @@map("chore_schedules")
}

model ChoreAssignment {
  id              String   @id @default(uuid())
  choreScheduleId String
  memberId        String
  rotationOrder   Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  choreSchedule ChoreSchedule @relation(fields: [choreScheduleId], references: [id], onDelete: Cascade)
  member        FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([choreScheduleId, memberId])
  @@map("chore_assignments")
}

enum ChoreStatus {
  PENDING
  COMPLETED
  APPROVED
  REJECTED
  SKIPPED
}

model ChoreInstance {
  id              String       @id @default(uuid())
  choreScheduleId String
  assignedToId    String
  dueDate         DateTime
  status          ChoreStatus  @default(PENDING)
  completedAt     DateTime?
  completedById   String?
  approvedById    String?
  approvedAt      DateTime?
  photoUrl        String?
  notes           String?
  creditsAwarded  Int?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  choreSchedule ChoreSchedule @relation(fields: [choreScheduleId], references: [id], onDelete: Cascade)
  assignedTo    FamilyMember  @relation("ChoreAssignedTo", fields: [assignedToId], references: [id], onDelete: Cascade)
  completedBy   FamilyMember? @relation("ChoreCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  approvedBy    FamilyMember? @relation("ChoreApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([choreScheduleId, dueDate, status])
  @@index([assignedToId, dueDate])
  @@map("chore_instances")
}

// ============================================
// SCREEN TIME MODULE
// ============================================

enum RolloverType {
  NONE
  FULL
  CAPPED
}

enum ResetDay {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

model ScreenTimeSettings {
  id                      String      @id @default(uuid())
  memberId                String      @unique
  weeklyAllocationMinutes Int
  resetDay                ResetDay    @default(SUNDAY)
  rolloverType            RolloverType @default(NONE)
  rolloverCapMinutes      Int?
  isActive                Boolean     @default(true)
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("screen_time_settings")
}

model ScreenTimeBalance {
  id                    String   @id @default(uuid())
  memberId              String   @unique
  currentBalanceMinutes Int
  weekStartDate         DateTime
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, weekStartDate])
  @@map("screen_time_balances")
}

enum ScreenTimeTransactionType {
  ALLOCATION
  EARNED
  SPENT
  ADJUSTMENT
  ROLLOVER
  GRACE_BORROWED
  GRACE_REPAID
}

enum DeviceType {
  TV
  TABLET
  PHONE
  COMPUTER
  GAMING
  OTHER
}

model ScreenTimeTransaction {
  id                     String                     @id @default(uuid())
  memberId               String
  type                   ScreenTimeTransactionType
  amountMinutes          Int
  balanceAfter           Int
  deviceType             DeviceType?
  reason                 String?
  relatedChoreInstanceId String?
  createdById            String
  notes                  String?
  createdAt              DateTime                   @default(now())

  // Relations
  member    FamilyMember @relation("ScreenTimeTransactions", fields: [memberId], references: [id], onDelete: Cascade)
  createdBy FamilyMember @relation("ScreenTimeTransactionsCreated", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([memberId, createdAt])
  @@map("screen_time_transactions")
}

enum GraceRepaymentMode {
  DEDUCT_NEXT_WEEK
  EARN_BACK
  FORGIVE
}

model ScreenTimeGraceSettings {
  id                         String              @id @default(uuid())
  memberId                   String              @unique
  gracePeriodMinutes         Int                 @default(15)
  maxGracePerDay             Int                 @default(1)
  maxGracePerWeek            Int                 @default(3)
  graceRepaymentMode         GraceRepaymentMode  @default(DEDUCT_NEXT_WEEK)
  lowBalanceWarningMinutes   Int                 @default(10)
  requiresApproval           Boolean             @default(false)
  createdAt                  DateTime            @default(now())
  updatedAt                  DateTime            @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("screen_time_grace_settings")
}

enum RepaymentStatus {
  PENDING
  DEDUCTED
  EARNED_BACK
  FORGIVEN
}

model GracePeriodLog {
  id                     String           @id @default(uuid())
  memberId               String
  requestedAt            DateTime         @default(now())
  minutesGranted         Int
  reason                 String?
  approvedById           String?
  repaymentStatus        RepaymentStatus  @default(PENDING)
  repaidAt               DateTime?
  relatedTransactionId   String?

  // Relations
  member     FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  approvedBy FamilyMember? @relation("GraceApprover", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([memberId, requestedAt])
  @@map("grace_period_logs")
}

// ============================================
// CREDITS MODULE
// ============================================

model CreditBalance {
  id              String   @id @default(uuid())
  memberId        String   @unique
  currentBalance  Int      @default(0)
  lifetimeEarned  Int      @default(0)
  lifetimeSpent   Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("credit_balances")
}

enum CreditTransactionType {
  CHORE_REWARD
  BONUS
  SCREENTIME_PURCHASE
  REWARD_REDEMPTION
  ADJUSTMENT
  TRANSFER
}

enum SpendingCategory {
  REWARDS
  SCREEN_TIME
  SAVINGS
  TRANSFER
  OTHER
}

model CreditTransaction {
  id                     String                @id @default(uuid())
  memberId               String
  type                   CreditTransactionType
  amount                 Int
  balanceAfter           Int
  reason                 String?
  category               SpendingCategory      @default(OTHER)
  relatedChoreInstanceId String?
  adjustedById           String?
  createdAt              DateTime              @default(now())

  // Relations
  member           FamilyMember       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  adjustedBy       FamilyMember?      @relation("CreditAdjuster", fields: [adjustedById], references: [id], onDelete: SetNull)
  rewardRedemption RewardRedemption?

  @@index([memberId, createdAt])
  @@index([memberId, createdAt, type, category])
  @@map("credit_transactions")
}

// ============================================
// REWARDS MODULE
// ============================================

enum RewardCategory {
  PRIVILEGE
  ITEM
  EXPERIENCE
  SCREEN_TIME
  OTHER
}

enum RewardStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

model RewardItem {
  id          String         @id @default(uuid())
  familyId    String
  name        String
  description String?
  category    RewardCategory @default(OTHER)
  costCredits Int
  quantity    Int?           // null = unlimited
  imageUrl    String?
  status      RewardStatus   @default(ACTIVE)
  createdById String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  family      Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy   FamilyMember        @relation("RewardCreator", fields: [createdById], references: [id], onDelete: Cascade)
  redemptions RewardRedemption[]

  @@index([familyId, status])
  @@map("reward_items")
}

enum RedemptionStatus {
  PENDING
  APPROVED
  REJECTED
  FULFILLED
}

model RewardRedemption {
  id                     String            @id @default(uuid())
  rewardId               String
  memberId               String
  creditTransactionId    String?           @unique
  status                 RedemptionStatus  @default(PENDING)
  requestedAt            DateTime          @default(now())
  approvedAt             DateTime?
  approvedById           String?
  rejectedAt             DateTime?
  rejectedById           String?
  rejectionReason        String?
  fulfilledAt            DateTime?
  fulfilledById          String?
  notes                  String?
  updatedAt              DateTime          @updatedAt

  // Relations
  reward            RewardItem         @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  member            FamilyMember       @relation("RedemptionRequester", fields: [memberId], references: [id], onDelete: Cascade)
  creditTransaction CreditTransaction? @relation(fields: [creditTransactionId], references: [id], onDelete: SetNull)
  approvedBy        FamilyMember?      @relation("RedemptionApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  rejectedBy        FamilyMember?      @relation("RedemptionRejecter", fields: [rejectedById], references: [id], onDelete: SetNull)
  fulfilledBy       FamilyMember?      @relation("RedemptionFulfiller", fields: [fulfilledById], references: [id], onDelete: SetNull)

  @@index([memberId, status])
  @@index([status, requestedAt])
  @@map("reward_redemptions")
}

// ============================================
// TODO MODULE
// ============================================

enum TodoPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TodoStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model TodoItem {
  id           String       @id @default(uuid())
  familyId     String
  title        String
  description  String?
  createdById  String
  assignedToId String?
  dueDate      DateTime?
  priority     TodoPriority @default(MEDIUM)
  category     String?
  isRecurring  Boolean      @default(false)
  status       TodoStatus   @default(PENDING)
  completedAt  DateTime?
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  family     Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy  FamilyMember  @relation("TodoCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignedTo FamilyMember? @relation("TodoAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([familyId, status, dueDate])
  @@index([assignedToId])
  @@map("todo_items")
}

// ============================================
// SHOPPING MODULE
// ============================================

model ShoppingList {
  id        String   @id @default(uuid())
  familyId  String
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  family Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  items  ShoppingItem[]

  @@index([familyId, isActive])
  @@map("shopping_lists")
}

enum ShoppingPriority {
  NORMAL
  NEEDED_SOON
  URGENT
}

enum ShoppingStatus {
  PENDING
  IN_CART
  PURCHASED
  REMOVED
}

model ShoppingItem {
  id           String           @id @default(uuid())
  listId       String
  name         String
  quantity     Int              @default(1)
  unit         String?
  category     String?
  priority     ShoppingPriority @default(NORMAL)
  status       ShoppingStatus   @default(PENDING)
  requestedById String
  addedById    String
  purchasedById String?
  purchasedAt  DateTime?
  projectId    String?          // Optional link to project
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  list        ShoppingList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  requestedBy FamilyMember  @relation("ShoppingItemRequester", fields: [requestedById], references: [id], onDelete: Cascade)
  addedBy     FamilyMember  @relation("ShoppingItemAdder", fields: [addedById], references: [id], onDelete: Cascade)
  purchasedBy FamilyMember? @relation("ShoppingItemPurchaser", fields: [purchasedById], references: [id], onDelete: SetNull)
  project     Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([listId, status])
  @@index([projectId])
  @@map("shopping_items")
}

// ============================================
// CALENDAR MODULE
// ============================================

enum EventType {
  INTERNAL
  GOOGLE
  OUTLOOK
  APPLE
}

model CalendarEvent {
  id          String    @id @default(uuid())
  familyId    String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  eventType   EventType @default(INTERNAL)
  externalId  String?
  color       String?
  isAllDay    Boolean   @default(false)
  projectId   String?   // Optional link to project
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  family      Family                    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy   FamilyMember              @relation("EventCreator", fields: [createdById], references: [id], onDelete: Cascade)
  project     Project?                  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  assignments CalendarEventAssignment[]

  @@index([familyId, startTime, endTime])
  @@index([projectId])
  @@map("calendar_events")
}

model CalendarEventAssignment {
  id      String @id @default(uuid())
  eventId String
  memberId String
  createdAt DateTime @default(now())

  // Relations
  event  CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([eventId, memberId])
  @@index([memberId])
  @@map("calendar_event_assignments")
}

// ============================================
// GUEST ACCESS
// ============================================

enum GuestAccessLevel {
  VIEW_ONLY
  LIMITED
  CAREGIVER
}

enum InviteStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

model GuestInvite {
  id           String           @id @default(uuid())
  familyId     String
  invitedById  String
  guestName    String
  guestEmail   String?
  accessLevel  GuestAccessLevel
  inviteCode   String           @unique
  inviteToken  String           @unique
  expiresAt    DateTime
  maxUses      Int              @default(1)
  useCount     Int              @default(0)
  status       InviteStatus     @default(PENDING)
  lastAccessedAt DateTime?
  createdAt    DateTime         @default(now())
  revokedAt    DateTime?

  // Relations
  family      Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  invitedBy   FamilyMember   @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  sessions    GuestSession[]

  @@index([familyId, status])
  @@index([inviteCode])
  @@index([inviteToken])
  @@map("guest_invites")
}

model GuestSession {
  id            String   @id @default(uuid())
  guestInviteId String
  sessionToken  String   @unique
  ipAddress     String
  userAgent     String
  startedAt     DateTime @default(now())
  expiresAt     DateTime
  endedAt       DateTime?

  // Relations
  guestInvite GuestInvite @relation(fields: [guestInviteId], references: [id], onDelete: Cascade)

  @@index([guestInviteId])
  @@index([sessionToken])
  @@map("guest_sessions")
}

// ============================================
// KIOSK MODE
// ============================================

model KioskSession {
  id                String    @id @default(uuid())
  familyId          String
  deviceId          String    @unique
  sessionToken      String    @unique @default(uuid())
  isActive          Boolean   @default(true)
  currentMemberId   String?
  lastActivityAt    DateTime  @default(now())
  autoLockMinutes   Int       @default(15)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  family            Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  currentMember     FamilyMember? @relation(fields: [currentMemberId], references: [id], onDelete: SetNull)

  @@index([familyId])
  @@index([deviceId])
  @@index([sessionToken])
  @@map("kiosk_sessions")
}

model KioskSettings {
  id                  String   @id @default(uuid())
  familyId            String   @unique
  isEnabled           Boolean  @default(true)
  autoLockMinutes     Int      @default(15)
  enabledWidgets      String[]
  allowGuestView      Boolean  @default(true)
  requirePinForSwitch Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  family              Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@map("kiosk_settings")
}

// ============================================
// FILE STORAGE
// ============================================

enum EntityType {
  AVATAR
  CHORE_PROOF
  BOARD_IMAGE
  PET_PHOTO
  MAINTENANCE_PHOTO
  DOCUMENT
}

enum StorageProvider {
  LOCAL
  S3
  CLOUDFLARE
}

model FileUpload {
  id               String          @id @default(uuid())
  familyId         String
  uploadedById     String
  entityType       EntityType
  entityId         String
  originalFilename String
  storagePath      String
  storageProvider  StorageProvider @default(LOCAL)
  mimeType         String
  fileSizeBytes    Int
  thumbnailPath    String?
  isPublic         Boolean         @default(false)
  uploadedAt       DateTime        @default(now())
  deletedAt        DateTime?

  // Relations
  family     Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploadedBy FamilyMember @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([familyId, entityType, entityId])
  @@map("file_uploads")
}

// ============================================
// AUDIT LOGGING
// ============================================

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PIN_CHANGE
  SESSION_EXPIRED

  // Family Management
  MEMBER_ADDED
  MEMBER_REMOVED
  MEMBER_UPDATED
  ROLE_CHANGED

  // Chores
  CHORE_COMPLETED
  CHORE_APPROVED
  CHORE_REJECTED
  CHORE_ASSIGNED

  // Credits
  CREDITS_AWARDED
  CREDITS_DEDUCTED
  REWARD_REDEEMED
  REWARD_APPROVED

  // Screen Time
  SCREENTIME_LOGGED
  SCREENTIME_ADJUSTED
  GRACE_PERIOD_USED

  // Routines
  ROUTINE_CREATED
  ROUTINE_UPDATED
  ROUTINE_DELETED
  ROUTINE_COMPLETED

  // Communication
  POST_CREATED
  POST_UPDATED
  POST_DELETED
  POST_PINNED
  POST_UNPINNED

  // Meal Planning
  MEAL_PLAN_CREATED
  MEAL_ENTRY_ADDED
  MEAL_ENTRY_UPDATED
  MEAL_ENTRY_DELETED

  // Leftovers
  LEFTOVER_LOGGED
  LEFTOVER_MARKED_USED
  LEFTOVER_MARKED_TOSSED

  // Recipes
  RECIPE_CREATED
  RECIPE_UPDATED
  RECIPE_DELETED
  RECIPE_RATED

  // Pets
  PET_ADDED
  PET_UPDATED
  PET_DELETED
  PET_FED
  PET_MEDICATION_GIVEN
  PET_VET_VISIT_LOGGED
  PET_WEIGHT_LOGGED

  // Inventory
  INVENTORY_ITEM_ADDED
  INVENTORY_ITEM_UPDATED
  INVENTORY_ITEM_DELETED
  INVENTORY_QUANTITY_ADJUSTED
  INVENTORY_ITEM_RESTOCKED

  // Maintenance
  MAINTENANCE_ITEM_CREATED
  MAINTENANCE_ITEM_UPDATED
  MAINTENANCE_ITEM_DELETED
  MAINTENANCE_TASK_COMPLETED

  // Guest Access
  GUEST_INVITE_CREATED
  GUEST_INVITE_REVOKED
  GUEST_SESSION_STARTED
  GUEST_SESSION_ENDED
  GUEST_ACCESS_DENIED

  // Kiosk Mode
  KIOSK_SESSION_STARTED
  KIOSK_SESSION_ENDED
  KIOSK_MEMBER_SWITCHED
  KIOSK_AUTO_LOCKED
  KIOSK_SETTINGS_UPDATED

  // Transportation & Carpool
  TRANSPORT_SCHEDULE_CREATED
  TRANSPORT_SCHEDULE_UPDATED
  TRANSPORT_SCHEDULE_DELETED
  TRANSPORT_LOCATION_ADDED
  TRANSPORT_DRIVER_ADDED
  CARPOOL_GROUP_CREATED
  CARPOOL_MEMBER_ADDED
  TRANSPORT_CONFIRMED

  // Document Vault
  DOCUMENT_UPLOADED
  DOCUMENT_UPDATED
  DOCUMENT_DELETED
  DOCUMENT_ACCESSED
  DOCUMENT_SHARED
  DOCUMENT_SHARE_ACCESSED

  // Medication Safety
  MEDICATION_SAFETY_CREATED
  MEDICATION_DOSE_LOGGED
  MEDICATION_DOSE_OVERRIDE
  MEDICATION_SAFETY_UPDATED
  MEDICATION_SAFETY_DELETED

  // Health & Wellbeing
  HEALTH_EVENT_CREATED
  HEALTH_EVENT_UPDATED
  HEALTH_EVENT_ENDED
  HEALTH_SYMPTOM_LOGGED
  HEALTH_MEDICATION_GIVEN
  TEMPERATURE_LOGGED
  MEDICAL_PROFILE_UPDATED

  // Shopping
  SHOPPING_ITEM_ADDED
  SHOPPING_ITEM_UPDATED
  SHOPPING_ITEM_DELETED

  // Rules Engine
  RULE_CREATED
  RULE_UPDATED
  RULE_DELETED
  RULE_ENABLED
  RULE_DISABLED
  RULE_EXECUTED
  RULE_TEST_RUN

  // Projects
  PROJECT_CREATED
  PROJECT_UPDATED
  PROJECT_DELETED
  PROJECT_STATUS_CHANGED
  PROJECT_TASK_CREATED
  PROJECT_TASK_UPDATED
  PROJECT_TASK_DELETED
  PROJECT_TASK_STATUS_CHANGED
  PROJECT_DEPENDENCY_ADDED
  PROJECT_DEPENDENCY_REMOVED

  // Settings
  SETTINGS_CHANGED
  MODULE_ENABLED
  MODULE_DISABLED

  // Security
  RATE_LIMIT_HIT
  AUTH_DENIED
  SUSPICIOUS_ACTIVITY
}

enum AuditResult {
  SUCCESS
  FAILURE
  DENIED
}

model AuditLog {
  id            String      @id @default(uuid())
  familyId      String
  memberId      String?
  sessionId     String?
  action        AuditAction
  entityType    String?
  entityId      String?
  previousValue Json?
  newValue      Json?
  metadata      Json?
  ipAddress     String?
  userAgent     String?
  result        AuditResult @default(SUCCESS)
  errorMessage  String?
  createdAt     DateTime    @default(now())
  expiresAt     DateTime?

  // Relations
  family Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  member FamilyMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  @@index([familyId, action, createdAt])
  @@index([memberId, createdAt])
  @@map("audit_logs")
}

// ============================================
// NOTIFICATIONS MODULE
// ============================================

enum NotificationType {
  CHORE_COMPLETED
  CHORE_APPROVED
  CHORE_REJECTED
  CHORE_ASSIGNED
  REWARD_REQUESTED
  REWARD_APPROVED
  REWARD_REJECTED
  CREDITS_EARNED
  CREDITS_SPENT
  SCREENTIME_ADJUSTED
  SCREENTIME_LOW
  TODO_ASSIGNED
  SHOPPING_REQUEST
  GENERAL
  // New PWA notification types (Feature 11)
  LEFTOVER_EXPIRING
  DOCUMENT_EXPIRING
  MEDICATION_AVAILABLE
  ROUTINE_TIME
  MAINTENANCE_DUE
  PET_CARE_REMINDER
  CARPOOL_REMINDER
  SAVINGS_GOAL_ACHIEVED
  BUSY_DAY_ALERT
  RULE_TRIGGERED
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  actionUrl String?
  metadata  Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  user FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// Web Push subscription storage for PWA push notifications
model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique // Web Push endpoint URL
  p256dh    String   // Public key for encryption
  auth      String   // Auth secret for encryption
  userAgent String?  // Browser/device info
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

// Notification preferences per user
model NotificationPreference {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  // Enabled notification types (array of NotificationType values)
  enabledTypes            String[] @default([])
  // Quiet hours configuration
  quietHoursEnabled       Boolean  @default(false)
  quietHoursStart         String?  // HH:MM format (e.g., "22:00")
  quietHoursEnd           String?  // HH:MM format (e.g., "07:00")
  // Push notification settings
  pushEnabled             Boolean  @default(true)
  inAppEnabled            Boolean  @default(true)
  // Specific notification type preferences
  leftoverExpiringHours   Int      @default(24) // Hours before expiration to notify
  documentExpiringDays    Int      @default(90) // Days before expiration to notify
  carpoolReminderMinutes  Int      @default(30) // Minutes before carpool to notify
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  user FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// ============================================
// GAMIFICATION MODULE
// ============================================

enum AchievementCategory {
  CHORES
  CREDITS
  STREAKS
  SOCIAL
  SPECIAL
}

enum BadgeTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

model Achievement {
  id          String              @id @default(uuid())
  key         String              @unique
  name        String
  description String
  category    AchievementCategory
  tier        BadgeTier           @default(BRONZE)
  iconName    String
  requirement Int // e.g., 10 chores, 100 credits
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  userAchievements UserAchievement[]

  @@index([category, tier])
  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  progress      Int      @default(0)
  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user        FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isCompleted])
  @@map("user_achievements")
}

enum StreakType {
  DAILY_CHORES
  WEEKLY_CHORES
  PERFECT_WEEK
  REWARD_SAVER
}

model Streak {
  id                String     @id @default(uuid())
  userId            String
  type              StreakType
  currentCount      Int        @default(0)
  longestCount      Int        @default(0)
  lastActivityDate  DateTime?
  isActive          Boolean    @default(true)
  frozenUntil       DateTime? // Streak protection/freeze
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  user FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId, isActive])
  @@map("streaks")
}

model LeaderboardEntry {
  id         String   @id @default(uuid())
  userId     String
  familyId   String
  period     String // "weekly", "monthly", "all-time"
  periodKey  String // "2025-W01", "2025-01", "all-time"
  score      Int      @default(0)
  rank       Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user   FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)
  family Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([userId, period, periodKey])
  @@index([familyId, period, periodKey, score])
  @@map("leaderboard_entries")
}

// ============================================
// ALLOWANCE & FINANCIAL TRACKING
// ============================================

model AllowanceSchedule {
  id              String    @id @default(uuid())
  memberId        String
  amount          Int
  frequency       Frequency
  dayOfWeek       Int? // 0-6 for Sunday-Saturday (for WEEKLY, BIWEEKLY)
  dayOfMonth      Int? // 1-28 (for MONTHLY)
  isActive        Boolean   @default(true)
  isPaused        Boolean   @default(false)
  startDate       DateTime  @default(now())
  endDate         DateTime?
  lastProcessedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, isActive])
  @@index([isActive, isPaused, lastProcessedAt])
  @@map("allowance_schedules")
}

model SavingsGoal {
  id            String    @id @default(uuid())
  memberId      String
  name          String
  description   String?
  targetAmount  Int
  currentAmount Int       @default(0)
  iconName      String    @default("currency-dollar")
  color         String    @default("blue")
  deadline      DateTime?
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, isCompleted])
  @@map("savings_goals")
}

model Budget {
  id          String           @id @default(uuid())
  memberId    String
  category    SpendingCategory
  limitAmount Int
  period      String // "weekly", "monthly"
  resetDay    Int              @default(0) // 0-6 for Sunday-Saturday
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  member  FamilyMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  periods BudgetPeriod[]

  @@unique([memberId, category, period])
  @@index([memberId, isActive])
  @@map("budgets")
}

model BudgetPeriod {
  id          String   @id @default(uuid())
  budgetId    String
  periodKey   String // "2025-W01", "2025-01"
  periodStart DateTime
  periodEnd   DateTime
  spent       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@unique([budgetId, periodKey])
  @@index([budgetId, periodStart])
  @@map("budget_periods")
}

// ============================================
// ROUTINES MODULE
// ============================================

model Routine {
  id          String              @id @default(uuid())
  familyId    String
  name        String
  type        RoutineType
  isWeekday   Boolean             @default(true)
  isWeekend   Boolean             @default(true)
  assignedTo  String?             // Specific child, or null for all
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  family      Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  assignee    FamilyMember?       @relation(fields: [assignedTo], references: [id], onDelete: Cascade)
  steps       RoutineStep[]
  completions RoutineCompletion[]

  @@index([familyId, assignedTo])
  @@map("routines")
}

model RoutineStep {
  id               String   @id @default(uuid())
  routineId        String
  name             String
  icon             String?  // Emoji or icon name
  estimatedMinutes Int?
  sortOrder        Int      @default(0)

  // Relations
  routine Routine @relation(fields: [routineId], references: [id], onDelete: Cascade)

  @@index([routineId, sortOrder])
  @@map("routine_steps")
}

model RoutineCompletion {
  id          String   @id @default(uuid())
  routineId   String
  memberId    String
  completedAt DateTime @default(now())
  date        DateTime // Just the date part for daily tracking

  // Relations
  routine Routine      @relation(fields: [routineId], references: [id], onDelete: Cascade)
  member  FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([routineId, memberId, date])
  @@index([memberId, date])
  @@index([routineId, date])
  @@map("routine_completions")
}

enum RoutineType {
  MORNING
  BEDTIME
  HOMEWORK
  AFTER_SCHOOL
  CUSTOM
}

model CommunicationPost {
  id        String         @id @default(uuid())
  familyId  String
  type      PostType
  title     String?
  content   String
  imageUrl  String?
  isPinned  Boolean        @default(false)
  expiresAt DateTime?
  authorId  String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  family    Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  author    FamilyMember   @relation("PostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  reactions PostReaction[]

  @@index([familyId, createdAt])
  @@index([familyId, isPinned])
  @@map("communication_posts")
}

model PostReaction {
  id        String   @id @default(uuid())
  postId    String
  memberId  String
  emoji     String
  createdAt DateTime @default(now())

  post   CommunicationPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  member FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([postId, memberId, emoji])
  @@index([postId])
  @@index([memberId])
  @@map("post_reactions")
}

enum PostType {
  ANNOUNCEMENT
  KUDOS
  NOTE
  PHOTO
}

// ============================================================
// Meal Planning Module
// ============================================================

model MealPlan {
  id        String          @id @default(uuid())
  familyId  String
  weekStart DateTime        // Monday of the week
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  family Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  meals  MealPlanEntry[]

  @@unique([familyId, weekStart])
  @@index([familyId])
  @@index([weekStart])
  @@map("meal_plans")
}

model MealPlanEntry {
  id         String    @id @default(uuid())
  mealPlanId String
  date       DateTime  // Specific day
  mealType   MealType
  recipeId   String?   // Future: link to Recipe model
  customName String?   // If not using a recipe
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  mealPlan MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)

  @@index([mealPlanId])
  @@index([date])
  @@map("meal_plan_entries")
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

// ============================================
// LEFTOVERS TRACKING
// ============================================

model Leftover {
  id              String   @id @default(uuid())
  familyId        String
  name            String
  mealPlanEntryId String?  // Link to original meal if applicable
  quantity        String?  // "Half a lasagna", "2 servings"
  storedAt        DateTime @default(now())
  expiresAt       DateTime // Auto-calculated based on default (3 days) + manual override
  usedAt          DateTime?
  tossedAt        DateTime?
  notes           String?
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  family  Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator FamilyMember @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([expiresAt])
  @@index([familyId, usedAt, tossedAt]) // For active leftovers query
  @@map("leftovers")
}

// ============================================
// RECIPE MANAGEMENT
// ============================================

model Recipe {
  id              String   @id @default(uuid())
  familyId        String
  name            String
  description     String?
  prepTimeMinutes Int?
  cookTimeMinutes Int?
  servings        Int      @default(4)
  difficulty      Difficulty @default(MEDIUM)
  imageUrl        String?
  sourceUrl       String?  // If imported from web
  instructions    String   // JSON array of steps
  notes           String?
  isFavorite      Boolean  @default(false)
  category        RecipeCategory?
  dietaryTags     DietaryTag[]
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  family      Family             @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator     FamilyMember       @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  ingredients RecipeIngredient[]
  ratings     RecipeRating[]

  @@index([familyId])
  @@index([category])
  @@index([isFavorite])
  @@map("recipes")
}

model RecipeIngredient {
  id        String  @id @default(uuid())
  recipeId  String
  name      String
  quantity  Float?  // Optional - some ingredients like "Salt to taste" don't have quantity
  unit      String? // Optional - cups, tbsp, lbs, oz, etc.
  notes     String? // "diced", "room temperature"
  sortOrder Int     @default(0)

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_ingredients")
}

model RecipeRating {
  id        String   @id @default(uuid())
  recipeId  String
  memberId  String
  rating    Int      // 1-5 stars
  notes     String?
  createdAt DateTime @default(now())

  recipe Recipe       @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([recipeId, memberId]) // One rating per member per recipe
  @@index([recipeId])
  @@map("recipe_ratings")
}

enum RecipeCategory {
  BREAKFAST
  LUNCH
  DINNER
  DESSERT
  SNACK
  SIDE
  APPETIZER
  DRINK
}

enum DietaryTag {
  VEGETARIAN
  VEGAN
  GLUTEN_FREE
  DAIRY_FREE
  NUT_FREE
  EGG_FREE
  SOY_FREE
  LOW_CARB
  KETO
  PALEO
}

// ============================================
// PET CARE MODULE
// ============================================

model Pet {
  id          String          @id @default(uuid())
  familyId    String
  name        String
  species     PetSpecies
  breed       String?
  birthday    DateTime?
  imageUrl    String?
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  family      Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  feedings    PetFeeding[]
  medications PetMedication[]
  vetVisits   PetVetVisit[]
  weights     PetWeight[]

  @@index([familyId])
  @@map("pets")
}

model PetFeeding {
  id        String       @id @default(uuid())
  petId     String
  fedAt     DateTime     @default(now())
  fedBy     String
  foodType  String?
  amount    String?
  notes     String?
  createdAt DateTime     @default(now())

  // Relations
  pet    Pet          @relation(fields: [petId], references: [id], onDelete: Cascade)
  member FamilyMember @relation(fields: [fedBy], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([fedAt])
  @@map("pet_feedings")
}

model PetMedication {
  id               String    @id @default(uuid())
  petId            String
  medicationName   String
  dosage           String
  frequency        String    // "Daily", "Twice daily", "As needed"
  minIntervalHours Int?      // For countdown timer
  lastGivenAt      DateTime?
  lastGivenBy      String?
  nextDoseAt       DateTime? // Calculated field
  notes            String?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  pet  Pet                 @relation(fields: [petId], references: [id], onDelete: Cascade)
  doses PetMedicationDose[]

  @@index([petId])
  @@index([nextDoseAt])
  @@map("pet_medications")
}

model PetMedicationDose {
  id               String         @id @default(uuid())
  medicationId     String
  givenAt          DateTime       @default(now())
  givenBy          String
  dosage           String
  notes            String?
  createdAt        DateTime       @default(now())

  // Relations
  medication PetMedication @relation(fields: [medicationId], references: [id], onDelete: Cascade)

  @@index([medicationId])
  @@index([givenAt])
  @@map("pet_medication_doses")
}

model PetVetVisit {
  id         String    @id @default(uuid())
  petId      String
  visitDate  DateTime
  reason     String
  diagnosis  String?
  treatment  String?
  cost       Float?
  nextVisit  DateTime?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([visitDate])
  @@map("pet_vet_visits")
}

model PetWeight {
  id         String   @id @default(uuid())
  petId      String
  weight     Float
  unit       String   // lbs or kg
  recordedAt DateTime @default(now())
  notes      String?

  // Relations
  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([recordedAt])
  @@map("pet_weights")
}

enum PetSpecies {
  DOG
  CAT
  BIRD
  FISH
  HAMSTER
  RABBIT
  GUINEA_PIG
  REPTILE
  OTHER
}

// ============================================
// HOUSEHOLD INVENTORY MODULE
// ============================================

model InventoryItem {
  id                String            @id @default(uuid())
  familyId          String
  name              String
  category          InventoryCategory
  location          InventoryLocation
  currentQuantity   Float             @default(0)
  unit              String            // count, oz, lbs, liters, etc.
  lowStockThreshold Float?
  expiresAt         DateTime?
  barcode           String?
  notes             String?
  lastRestockedAt   DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([category])
  @@index([expiresAt])
  @@index([currentQuantity])
  @@map("inventory_items")
}

enum InventoryCategory {
  FOOD_PANTRY
  FOOD_FRIDGE
  FOOD_FREEZER
  CLEANING
  TOILETRIES
  PAPER_GOODS
  MEDICINE
  PET_SUPPLIES
  OTHER
}

enum InventoryLocation {
  PANTRY
  FRIDGE
  FREEZER
  BATHROOM
  GARAGE
  LAUNDRY_ROOM
  KITCHEN_CABINET
  OTHER
}

// ============================================
// HOUSEHOLD MAINTENANCE MODULE
// ============================================

model MaintenanceItem {
  id              String                  @id @default(uuid())
  familyId        String
  name            String
  description     String?
  category        MaintenanceCategory
  frequency       String // "Every 3 months", "Annual", "As needed"
  season          Season? // For seasonal tasks
  lastCompletedAt DateTime?
  nextDueAt       DateTime?
  estimatedCost   Float?
  notes           String?
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  // Relations
  family      Family                  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  completions MaintenanceCompletion[]

  @@index([familyId])
  @@index([nextDueAt])
  @@index([category])
  @@map("maintenance_items")
}

model MaintenanceCompletion {
  id                String          @id @default(uuid())
  maintenanceItemId String
  completedAt       DateTime        @default(now())
  completedBy       String
  cost              Float?
  serviceProvider   String?
  notes             String?
  photoUrls         String[] // Array of photo URLs

  // Relations
  item   MaintenanceItem @relation(fields: [maintenanceItemId], references: [id], onDelete: Cascade)
  member FamilyMember    @relation(fields: [completedBy], references: [id], onDelete: Cascade)

  @@index([maintenanceItemId])
  @@index([completedAt])
  @@map("maintenance_completions")
}

enum MaintenanceCategory {
  HVAC
  PLUMBING
  ELECTRICAL
  EXTERIOR
  INTERIOR
  LAWN_GARDEN
  APPLIANCES
  SAFETY
  SEASONAL
  OTHER
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
}

// ============================================
// TRANSPORTATION & CARPOOL MODULE
// ============================================

model TransportSchedule {
  id          String    @id @default(uuid())
  familyId    String
  memberId    String
  dayOfWeek   Int       // 0-6 (Sunday-Saturday)
  time        String    // HH:MM format (24-hour)
  type        TransportType
  locationId  String?
  driverId    String?
  carpoolId   String?
  notes       String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  family    Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  member    FamilyMember        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  location  TransportLocation?  @relation(fields: [locationId], references: [id], onDelete: SetNull)
  driver    TransportDriver?    @relation(fields: [driverId], references: [id], onDelete: SetNull)
  carpool   CarpoolGroup?       @relation(fields: [carpoolId], references: [id], onDelete: SetNull)

  @@index([familyId])
  @@index([memberId])
  @@index([dayOfWeek])
  @@map("transport_schedules")
}

model TransportLocation {
  id        String              @id @default(uuid())
  familyId  String
  name      String
  address   String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  // Relations
  family    Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  schedules TransportSchedule[]

  @@index([familyId])
  @@map("transport_locations")
}

model TransportDriver {
  id           String              @id @default(uuid())
  familyId     String
  name         String
  phone        String?
  relationship String?             // "Mom", "Dad", "Grandma", "Carpool Parent"
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  // Relations
  family    Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  schedules TransportSchedule[]

  @@index([familyId])
  @@map("transport_drivers")
}

model CarpoolGroup {
  id        String              @id @default(uuid())
  familyId  String
  name      String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  // Relations
  family    Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  members   CarpoolMember[]
  schedules TransportSchedule[]

  @@index([familyId])
  @@map("carpool_groups")
}

model CarpoolMember {
  id        String       @id @default(uuid())
  carpoolId String
  name      String
  phone     String?
  email     String?
  createdAt DateTime     @default(now())

  // Relations
  carpool CarpoolGroup @relation(fields: [carpoolId], references: [id], onDelete: Cascade)

  @@index([carpoolId])
  @@map("carpool_members")
}

enum TransportType {
  PICKUP
  DROPOFF
}

// ============================================
// DOCUMENT VAULT MODULE
// ============================================

model Document {
  id             String                @id @default(uuid())
  familyId       String
  name           String
  category       DocumentCategory
  fileUrl        String                // S3/MinIO URL or local path
  fileSize       Int                   // Bytes
  mimeType       String
  documentNumber String?               // Masked in UI (show last 4 only)
  issuedDate     DateTime?
  expiresAt      DateTime?
  tags           String[]              // Array of tags for search
  notes          String?
  uploadedBy     String
  accessList     String[]              // Array of member IDs who can view
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  // Relations
  family      Family                  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploader    FamilyMember            @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)
  versions    DocumentVersion[]
  shareLinks  DocumentShareLink[]
  accessLogs  DocumentAccessLog[]

  @@index([familyId])
  @@index([category])
  @@index([expiresAt])
  @@map("documents")
}

model DocumentVersion {
  id         String   @id @default(uuid())
  documentId String
  version    Int
  fileUrl    String
  uploadedBy String
  uploadedAt DateTime @default(now())
  notes      String?

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("document_versions")
}

model DocumentShareLink {
  id             String    @id @default(uuid())
  documentId     String
  token          String    @unique
  expiresAt      DateTime
  password       String?   // Hashed
  accessCount    Int       @default(0)
  maxAccess      Int?      // Limit number of accesses
  createdBy      String
  createdAt      DateTime  @default(now())
  lastAccessedAt DateTime? // Last time the link was accessed
  revokedAt      DateTime? // When the link was revoked
  revokedBy      String?   // Who revoked the link

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([token])
  @@map("document_share_links")
}

model DocumentAccessLog {
  id             String       @id @default(uuid())
  documentId     String
  accessedBy     String?      // Null for external/anonymous access via share link
  accessedAt     DateTime     @default(now())
  ipAddress      String?
  userAgent      String?      // Browser user agent string
  viaShareLink   String?      // ID of share link if accessed externally

  // Relations
  document Document      @relation(fields: [documentId], references: [id], onDelete: Cascade)
  member   FamilyMember? @relation(fields: [accessedBy], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([accessedBy])
  @@map("document_access_logs")
}

enum DocumentCategory {
  IDENTITY    // Passports, birth certificates, SSN cards
  MEDICAL     // Insurance cards, vaccination records
  FINANCIAL   // Bank statements, tax documents
  HOUSEHOLD   // Warranties, manuals, receipts
  EDUCATION   // Report cards, transcripts, diplomas
  LEGAL       // Wills, powers of attorney, contracts
  PETS        // Vet records, licenses
  OTHER
}

// ============================================
// MEDICATION SAFETY INTERLOCK MODULE
// ============================================

model MedicationSafety {
  id                  String             @id @default(uuid())
  memberId            String
  medicationName      String
  activeIngredient    String?            // For cross-medication checking
  minIntervalHours    Int                // Minimum hours between doses
  maxDosesPerDay      Int?               // Daily limit
  lastDoseAt          DateTime?
  nextDoseAvailableAt DateTime?          // Calculated field
  notifyWhenReady     Boolean            @default(true)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // Relations
  member FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  doses  MedicationDose[]

  @@index([memberId])
  @@index([nextDoseAvailableAt])
  @@map("medication_safety")
}

model MedicationDose {
  id                   String           @id @default(uuid())
  medicationSafetyId   String
  givenAt              DateTime         @default(now())
  givenBy              String
  dosage               String
  notes                String?
  wasOverride          Boolean          @default(false)
  overrideReason       String?
  overrideApprovedBy   String?

  // Relations
  medicationSafety MedicationSafety @relation(fields: [medicationSafetyId], references: [id], onDelete: Cascade)

  @@index([medicationSafetyId])
  @@index([givenAt])
  @@map("medication_doses")
}

// ============================================
// HEALTH & WELLBEING MODULE
// ============================================

model HealthEvent {
  id          String          @id @default(uuid())
  memberId    String
  eventType   HealthEventType
  startedAt   DateTime        @default(now())
  endedAt     DateTime?
  severity    Int?            // 1-10 scale
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  member      FamilyMember    @relation(fields: [memberId], references: [id], onDelete: Cascade)
  symptoms    HealthSymptom[]
  medications HealthMedication[]

  @@index([memberId])
  @@index([startedAt])
  @@index([eventType])
  @@map("health_events")
}

model HealthSymptom {
  id             String       @id @default(uuid())
  healthEventId  String
  symptomType    SymptomType
  severity       Int          // 1-10
  notes          String?
  recordedAt     DateTime     @default(now())

  // Relations
  healthEvent HealthEvent @relation(fields: [healthEventId], references: [id], onDelete: Cascade)

  @@index([healthEventId])
  @@index([recordedAt])
  @@map("health_symptoms")
}

model HealthMedication {
  id             String      @id @default(uuid())
  healthEventId  String
  medicationName String
  dosage         String
  givenAt        DateTime
  givenBy        String
  nextDoseAt     DateTime?   // For countdown timer
  notes          String?

  // Relations
  healthEvent HealthEvent @relation(fields: [healthEventId], references: [id], onDelete: Cascade)

  @@index([healthEventId])
  @@index([givenAt])
  @@index([nextDoseAt])
  @@map("health_medications")
}

model TemperatureLog {
  id          String       @id @default(uuid())
  memberId    String
  temperature Float        // In Fahrenheit
  method      TempMethod   // ORAL, RECTAL, ARMPIT, EAR, FOREHEAD
  recordedAt  DateTime     @default(now())
  notes       String?

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([recordedAt])
  @@map("temperature_logs")
}

model MedicalProfile {
  id          String       @id @default(uuid())
  memberId    String       @unique
  bloodType   String?
  allergies   String[]     // Array of allergy strings
  conditions  String[]     // Array of medical conditions
  medications String[]     // Long-term medications
  weight      Float?       // For dosage calculations
  weightUnit  String?      // lbs or kg
  updatedAt   DateTime     @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("medical_profiles")
}

enum HealthEventType {
  ILLNESS
  INJURY
  DOCTOR_VISIT
  WELLNESS_CHECK
  VACCINATION
  OTHER
}

enum SymptomType {
  FEVER
  COUGH
  SORE_THROAT
  RUNNY_NOSE
  HEADACHE
  STOMACH_ACHE
  VOMITING
  DIARRHEA
  RASH
  FATIGUE
  LOSS_OF_APPETITE
  OTHER
}

enum TempMethod {
  ORAL
  RECTAL
  ARMPIT
  EAR
  FOREHEAD
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  BLOCKED
  CANCELLED
}

enum DependencyType {
  FINISH_TO_START
  START_TO_START
  BLOCKING
}

// ============================================
// RULES ENGINE & AUTOMATION MODULE
// ============================================

model AutomationRule {
  id          String   @id @default(uuid())
  familyId    String
  name        String
  description String?
  trigger     Json     // { type: TriggerType, config: {...} }
  conditions  Json?    // Optional: { operator: 'AND'|'OR', rules: [...] }
  actions     Json     // Array: [{ type: ActionType, config: {...} }]
  isEnabled   Boolean  @default(true)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  family     Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator    FamilyMember    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  executions RuleExecution[]

  @@index([familyId, isEnabled])
  @@index([createdAt])
  @@map("automation_rules")
}

model RuleExecution {
  id         String   @id @default(uuid())
  ruleId     String
  success    Boolean
  result     Json?    // { actionsCompleted: number, errors: [], results: [] }
  error      String?
  metadata   Json?    // Trigger context, matched conditions, etc.
  executedAt DateTime @default(now())

  // Relations
  rule AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId, executedAt])
  @@index([success, executedAt])
  @@map("rule_executions")
}

// ============================================
// PROJECTS MODULE
// ============================================

model Project {
  id          String        @id @default(uuid())
  familyId    String
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  startDate   DateTime?
  dueDate     DateTime?
  budget      Float?
  notes       String?
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  family   Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator  FamilyMember  @relation("ProjectCreator", fields: [createdById], references: [id], onDelete: Cascade)
  tasks    ProjectTask[]
  shopping ShoppingItem[]
  events   CalendarEvent[]

  @@index([familyId, status])
  @@index([createdAt])
  @@map("projects")
}

model ProjectTask {
  id             String       @id @default(uuid())
  projectId      String
  name           String
  description    String?
  status         TaskStatus   @default(PENDING)
  assigneeId     String?
  dueDate        DateTime?
  estimatedHours Float?
  actualHours    Float?
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee     FamilyMember?    @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  dependencies TaskDependency[] @relation("DependentTask")
  dependents   TaskDependency[] @relation("BlockingTask")

  @@index([projectId, sortOrder])
  @@index([assigneeId])
  @@index([status])
  @@map("project_tasks")
}

model TaskDependency {
  id              String         @id @default(uuid())
  dependentTaskId String // Task that is blocked
  blockingTaskId  String // Task that must complete first
  dependencyType  DependencyType @default(FINISH_TO_START)
  createdAt       DateTime       @default(now())

  // Relations
  dependentTask ProjectTask @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
  blockingTask  ProjectTask @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)

  @@unique([dependentTaskId, blockingTaskId])
  @@index([dependentTaskId])
  @@index([blockingTaskId])
  @@map("task_dependencies")
}
