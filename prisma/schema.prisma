// This is your Prisma schema file for Hearth - Household ERP
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE MODELS - Family & Members
// ============================================

model Family {
  id        String   @id @default(uuid())
  name      String
  timezone  String   @default("America/New_York")
  settings  Json?    @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members                FamilyMember[]
  moduleConfigurations   ModuleConfiguration[]
  auditLogs              AuditLog[]
  choreDefinitions       ChoreDefinition[]
  todoItems              TodoItem[]
  shoppingLists          ShoppingList[]
  calendarEvents         CalendarEvent[]
  guestInvites           GuestInvite[]
  fileUploads            FileUpload[]
  rewardItems            RewardItem[]
  leaderboardEntries     LeaderboardEntry[]
  routines               Routine[]
  communicationPosts     CommunicationPost[]

  @@map("families")
}

enum Role {
  PARENT
  CHILD
  GUEST
}

model FamilyMember {
  id           String    @id @default(uuid())
  familyId     String
  name         String
  email        String?   @unique
  passwordHash String?   // For parents
  pin          String?   // Hashed, for children
  role         Role
  birthDate    DateTime?
  avatarUrl    String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  // Relations
  family                            Family                    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdTodos                      TodoItem[]                @relation("TodoCreator")
  assignedTodos                     TodoItem[]                @relation("TodoAssignee")
  shoppingItemsRequested            ShoppingItem[]            @relation("ShoppingItemRequester")
  shoppingItemsAdded                ShoppingItem[]            @relation("ShoppingItemAdder")
  shoppingItemsPurchased            ShoppingItem[]            @relation("ShoppingItemPurchaser")
  createdEvents                     CalendarEvent[]           @relation("EventCreator")
  eventAssignments                  CalendarEventAssignment[]
  choreAssignments                  ChoreAssignment[]
  choreInstancesAssigned            ChoreInstance[]           @relation("ChoreAssignedTo")
  choreInstancesCompleted           ChoreInstance[]           @relation("ChoreCompletedBy")
  choreInstancesApproved            ChoreInstance[]           @relation("ChoreApprovedBy")
  screenTimeSettings                ScreenTimeSettings?
  screenTimeBalance                 ScreenTimeBalance?
  screenTimeTransactions            ScreenTimeTransaction[]   @relation("ScreenTimeTransactions")
  screenTimeTransactionsCreated     ScreenTimeTransaction[]   @relation("ScreenTimeTransactionsCreated")
  screenTimeGraceSettings           ScreenTimeGraceSettings?
  gracePeriodLogs                   GracePeriodLog[]
  gracePeriodApprovals              GracePeriodLog[]          @relation("GraceApprover")
  creditBalance                     CreditBalance?
  creditTransactions                CreditTransaction[]
  creditAdjustmentsCreated          CreditTransaction[]       @relation("CreditAdjuster")
  rewardsCreated                    RewardItem[]              @relation("RewardCreator")
  redemptionsRequested              RewardRedemption[]        @relation("RedemptionRequester")
  redemptionsApproved               RewardRedemption[]        @relation("RedemptionApprover")
  redemptionsRejected               RewardRedemption[]        @relation("RedemptionRejecter")
  redemptionsFulfilled              RewardRedemption[]        @relation("RedemptionFulfiller")
  auditLogsCreated                  AuditLog[]
  guestInvitesCreated               GuestInvite[]
  fileUploadsCreated                FileUpload[]
  notifications                     Notification[]
  achievements                      UserAchievement[]
  streaks                           Streak[]
  leaderboardEntries                LeaderboardEntry[]
  allowanceSchedules                AllowanceSchedule[]
  savingsGoals                      SavingsGoal[]
  budgets                           Budget[]
  routinesAssigned                  Routine[]
  routineCompletions                RoutineCompletion[]
  postsAuthored                     CommunicationPost[]   @relation("PostAuthor")
  postReactions                     PostReaction[]

  @@index([familyId])
  @@index([email])
  @@map("family_members")
}

// ============================================
// MODULE CONFIGURATION
// ============================================

enum ModuleId {
  CHORES
  SCREEN_TIME
  CREDITS
  SHOPPING
  CALENDAR
  TODOS
  ROUTINES
  MEAL_PLANNING
  RECIPES
  INVENTORY
  HEALTH
  PROJECTS
  COMMUNICATION
  TRANSPORT
  PETS
  MAINTENANCE
  DOCUMENTS
}

model ModuleConfiguration {
  id         String    @id @default(uuid())
  familyId   String
  moduleId   ModuleId  @unique
  isEnabled  Boolean   @default(true)
  enabledAt  DateTime?
  disabledAt DateTime?
  settings   Json?     @default("{}")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId, moduleId])
  @@map("module_configurations")
}

// ============================================
// CHORES MODULE
// ============================================

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model ChoreDefinition {
  id               String   @id @default(uuid())
  familyId         String
  name             String
  description      String?
  instructions     String?
  estimatedMinutes Int
  difficulty       Difficulty
  creditValue      Int      @default(0)
  minimumAge       Int?
  iconName         String   @default("task")
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  family    Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  schedules ChoreSchedule[]

  @@index([familyId, isActive])
  @@map("chore_definitions")
}

enum AssignmentType {
  FIXED
  ROTATING
  OPT_IN
}

enum Frequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  CUSTOM
}

model ChoreSchedule {
  id                String         @id @default(uuid())
  choreDefinitionId String
  assignmentType    AssignmentType
  frequency         Frequency
  customCron        String?
  dayOfWeek         Int?           // 0-6, for weekly
  requiresApproval  Boolean        @default(false)
  requiresPhoto     Boolean        @default(false)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  choreDefinition ChoreDefinition   @relation(fields: [choreDefinitionId], references: [id], onDelete: Cascade)
  assignments     ChoreAssignment[]
  instances       ChoreInstance[]

  @@index([choreDefinitionId, isActive])
  @@map("chore_schedules")
}

model ChoreAssignment {
  id              String   @id @default(uuid())
  choreScheduleId String
  memberId        String
  rotationOrder   Int?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  choreSchedule ChoreSchedule @relation(fields: [choreScheduleId], references: [id], onDelete: Cascade)
  member        FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([choreScheduleId, memberId])
  @@map("chore_assignments")
}

enum ChoreStatus {
  PENDING
  COMPLETED
  APPROVED
  REJECTED
  SKIPPED
}

model ChoreInstance {
  id              String       @id @default(uuid())
  choreScheduleId String
  assignedToId    String
  dueDate         DateTime
  status          ChoreStatus  @default(PENDING)
  completedAt     DateTime?
  completedById   String?
  approvedById    String?
  approvedAt      DateTime?
  photoUrl        String?
  notes           String?
  creditsAwarded  Int?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  choreSchedule ChoreSchedule @relation(fields: [choreScheduleId], references: [id], onDelete: Cascade)
  assignedTo    FamilyMember  @relation("ChoreAssignedTo", fields: [assignedToId], references: [id], onDelete: Cascade)
  completedBy   FamilyMember? @relation("ChoreCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)
  approvedBy    FamilyMember? @relation("ChoreApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([choreScheduleId, dueDate, status])
  @@index([assignedToId, dueDate])
  @@map("chore_instances")
}

// ============================================
// SCREEN TIME MODULE
// ============================================

enum RolloverType {
  NONE
  FULL
  CAPPED
}

enum ResetDay {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

model ScreenTimeSettings {
  id                      String      @id @default(uuid())
  memberId                String      @unique
  weeklyAllocationMinutes Int
  resetDay                ResetDay    @default(SUNDAY)
  rolloverType            RolloverType @default(NONE)
  rolloverCapMinutes      Int?
  isActive                Boolean     @default(true)
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("screen_time_settings")
}

model ScreenTimeBalance {
  id                    String   @id @default(uuid())
  memberId              String   @unique
  currentBalanceMinutes Int
  weekStartDate         DateTime
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, weekStartDate])
  @@map("screen_time_balances")
}

enum ScreenTimeTransactionType {
  ALLOCATION
  EARNED
  SPENT
  ADJUSTMENT
  ROLLOVER
  GRACE_BORROWED
  GRACE_REPAID
}

enum DeviceType {
  TV
  TABLET
  PHONE
  COMPUTER
  GAMING
  OTHER
}

model ScreenTimeTransaction {
  id                     String                     @id @default(uuid())
  memberId               String
  type                   ScreenTimeTransactionType
  amountMinutes          Int
  balanceAfter           Int
  deviceType             DeviceType?
  reason                 String?
  relatedChoreInstanceId String?
  createdById            String
  notes                  String?
  createdAt              DateTime                   @default(now())

  // Relations
  member    FamilyMember @relation("ScreenTimeTransactions", fields: [memberId], references: [id], onDelete: Cascade)
  createdBy FamilyMember @relation("ScreenTimeTransactionsCreated", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([memberId, createdAt])
  @@map("screen_time_transactions")
}

enum GraceRepaymentMode {
  DEDUCT_NEXT_WEEK
  EARN_BACK
  FORGIVE
}

model ScreenTimeGraceSettings {
  id                         String              @id @default(uuid())
  memberId                   String              @unique
  gracePeriodMinutes         Int                 @default(15)
  maxGracePerDay             Int                 @default(1)
  maxGracePerWeek            Int                 @default(3)
  graceRepaymentMode         GraceRepaymentMode  @default(DEDUCT_NEXT_WEEK)
  lowBalanceWarningMinutes   Int                 @default(10)
  requiresApproval           Boolean             @default(false)
  createdAt                  DateTime            @default(now())
  updatedAt                  DateTime            @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("screen_time_grace_settings")
}

enum RepaymentStatus {
  PENDING
  DEDUCTED
  EARNED_BACK
  FORGIVEN
}

model GracePeriodLog {
  id                     String           @id @default(uuid())
  memberId               String
  requestedAt            DateTime         @default(now())
  minutesGranted         Int
  reason                 String?
  approvedById           String?
  repaymentStatus        RepaymentStatus  @default(PENDING)
  repaidAt               DateTime?
  relatedTransactionId   String?

  // Relations
  member     FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  approvedBy FamilyMember? @relation("GraceApprover", fields: [approvedById], references: [id], onDelete: SetNull)

  @@index([memberId, requestedAt])
  @@map("grace_period_logs")
}

// ============================================
// CREDITS MODULE
// ============================================

model CreditBalance {
  id              String   @id @default(uuid())
  memberId        String   @unique
  currentBalance  Int      @default(0)
  lifetimeEarned  Int      @default(0)
  lifetimeSpent   Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@map("credit_balances")
}

enum CreditTransactionType {
  CHORE_REWARD
  BONUS
  SCREENTIME_PURCHASE
  REWARD_REDEMPTION
  ADJUSTMENT
  TRANSFER
}

enum SpendingCategory {
  REWARDS
  SCREEN_TIME
  SAVINGS
  TRANSFER
  OTHER
}

model CreditTransaction {
  id                     String                @id @default(uuid())
  memberId               String
  type                   CreditTransactionType
  amount                 Int
  balanceAfter           Int
  reason                 String?
  category               SpendingCategory      @default(OTHER)
  relatedChoreInstanceId String?
  adjustedById           String?
  createdAt              DateTime              @default(now())

  // Relations
  member           FamilyMember       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  adjustedBy       FamilyMember?      @relation("CreditAdjuster", fields: [adjustedById], references: [id], onDelete: SetNull)
  rewardRedemption RewardRedemption?

  @@index([memberId, createdAt])
  @@index([memberId, createdAt, type, category])
  @@map("credit_transactions")
}

// ============================================
// REWARDS MODULE
// ============================================

enum RewardCategory {
  PRIVILEGE
  ITEM
  EXPERIENCE
  SCREEN_TIME
  OTHER
}

enum RewardStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

model RewardItem {
  id          String         @id @default(uuid())
  familyId    String
  name        String
  description String?
  category    RewardCategory @default(OTHER)
  costCredits Int
  quantity    Int?           // null = unlimited
  imageUrl    String?
  status      RewardStatus   @default(ACTIVE)
  createdById String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  family      Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy   FamilyMember        @relation("RewardCreator", fields: [createdById], references: [id], onDelete: Cascade)
  redemptions RewardRedemption[]

  @@index([familyId, status])
  @@map("reward_items")
}

enum RedemptionStatus {
  PENDING
  APPROVED
  REJECTED
  FULFILLED
}

model RewardRedemption {
  id                     String            @id @default(uuid())
  rewardId               String
  memberId               String
  creditTransactionId    String?           @unique
  status                 RedemptionStatus  @default(PENDING)
  requestedAt            DateTime          @default(now())
  approvedAt             DateTime?
  approvedById           String?
  rejectedAt             DateTime?
  rejectedById           String?
  rejectionReason        String?
  fulfilledAt            DateTime?
  fulfilledById          String?
  notes                  String?
  updatedAt              DateTime          @updatedAt

  // Relations
  reward            RewardItem         @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  member            FamilyMember       @relation("RedemptionRequester", fields: [memberId], references: [id], onDelete: Cascade)
  creditTransaction CreditTransaction? @relation(fields: [creditTransactionId], references: [id], onDelete: SetNull)
  approvedBy        FamilyMember?      @relation("RedemptionApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  rejectedBy        FamilyMember?      @relation("RedemptionRejecter", fields: [rejectedById], references: [id], onDelete: SetNull)
  fulfilledBy       FamilyMember?      @relation("RedemptionFulfiller", fields: [fulfilledById], references: [id], onDelete: SetNull)

  @@index([memberId, status])
  @@index([status, requestedAt])
  @@map("reward_redemptions")
}

// ============================================
// TODO MODULE
// ============================================

enum TodoPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TodoStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model TodoItem {
  id           String       @id @default(uuid())
  familyId     String
  title        String
  description  String?
  createdById  String
  assignedToId String?
  dueDate      DateTime?
  priority     TodoPriority @default(MEDIUM)
  category     String?
  isRecurring  Boolean      @default(false)
  status       TodoStatus   @default(PENDING)
  completedAt  DateTime?
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  family     Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy  FamilyMember  @relation("TodoCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignedTo FamilyMember? @relation("TodoAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([familyId, status, dueDate])
  @@index([assignedToId])
  @@map("todo_items")
}

// ============================================
// SHOPPING MODULE
// ============================================

model ShoppingList {
  id        String   @id @default(uuid())
  familyId  String
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  family Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  items  ShoppingItem[]

  @@index([familyId, isActive])
  @@map("shopping_lists")
}

enum ShoppingPriority {
  NORMAL
  NEEDED_SOON
  URGENT
}

enum ShoppingStatus {
  PENDING
  IN_CART
  PURCHASED
  REMOVED
}

model ShoppingItem {
  id           String           @id @default(uuid())
  listId       String
  name         String
  quantity     Int              @default(1)
  unit         String?
  category     String?
  priority     ShoppingPriority @default(NORMAL)
  status       ShoppingStatus   @default(PENDING)
  requestedById String
  addedById    String
  purchasedById String?
  purchasedAt  DateTime?
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  list        ShoppingList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  requestedBy FamilyMember  @relation("ShoppingItemRequester", fields: [requestedById], references: [id], onDelete: Cascade)
  addedBy     FamilyMember  @relation("ShoppingItemAdder", fields: [addedById], references: [id], onDelete: Cascade)
  purchasedBy FamilyMember? @relation("ShoppingItemPurchaser", fields: [purchasedById], references: [id], onDelete: SetNull)

  @@index([listId, status])
  @@map("shopping_items")
}

// ============================================
// CALENDAR MODULE
// ============================================

enum EventType {
  INTERNAL
  GOOGLE
  OUTLOOK
  APPLE
}

model CalendarEvent {
  id          String    @id @default(uuid())
  familyId    String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  eventType   EventType @default(INTERNAL)
  externalId  String?
  color       String?
  isAllDay    Boolean   @default(false)
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  family      Family                    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy   FamilyMember              @relation("EventCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignments CalendarEventAssignment[]

  @@index([familyId, startTime, endTime])
  @@map("calendar_events")
}

model CalendarEventAssignment {
  id      String @id @default(uuid())
  eventId String
  memberId String
  createdAt DateTime @default(now())

  // Relations
  event  CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member FamilyMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([eventId, memberId])
  @@index([memberId])
  @@map("calendar_event_assignments")
}

// ============================================
// GUEST ACCESS
// ============================================

enum GuestAccessLevel {
  VIEW_ONLY
  LIMITED
  CAREGIVER
}

enum InviteStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

model GuestInvite {
  id           String           @id @default(uuid())
  familyId     String
  invitedById  String
  guestName    String
  guestEmail   String?
  accessLevel  GuestAccessLevel
  inviteCode   String           @unique
  inviteToken  String           @unique
  expiresAt    DateTime
  maxUses      Int              @default(1)
  useCount     Int              @default(0)
  status       InviteStatus     @default(PENDING)
  lastAccessedAt DateTime?
  createdAt    DateTime         @default(now())
  revokedAt    DateTime?

  // Relations
  family      Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  invitedBy   FamilyMember   @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  sessions    GuestSession[]

  @@index([familyId, status])
  @@index([inviteCode])
  @@index([inviteToken])
  @@map("guest_invites")
}

model GuestSession {
  id            String   @id @default(uuid())
  guestInviteId String
  sessionToken  String   @unique
  ipAddress     String
  userAgent     String
  startedAt     DateTime @default(now())
  expiresAt     DateTime
  endedAt       DateTime?

  // Relations
  guestInvite GuestInvite @relation(fields: [guestInviteId], references: [id], onDelete: Cascade)

  @@index([guestInviteId])
  @@index([sessionToken])
  @@map("guest_sessions")
}

// ============================================
// FILE STORAGE
// ============================================

enum EntityType {
  AVATAR
  CHORE_PROOF
  BOARD_IMAGE
  PET_PHOTO
  MAINTENANCE_PHOTO
  DOCUMENT
}

enum StorageProvider {
  LOCAL
  S3
  CLOUDFLARE
}

model FileUpload {
  id               String          @id @default(uuid())
  familyId         String
  uploadedById     String
  entityType       EntityType
  entityId         String
  originalFilename String
  storagePath      String
  storageProvider  StorageProvider @default(LOCAL)
  mimeType         String
  fileSizeBytes    Int
  thumbnailPath    String?
  isPublic         Boolean         @default(false)
  uploadedAt       DateTime        @default(now())
  deletedAt        DateTime?

  // Relations
  family     Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploadedBy FamilyMember @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([familyId, entityType, entityId])
  @@map("file_uploads")
}

// ============================================
// AUDIT LOGGING
// ============================================

enum AuditAction {
  // Authentication
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PIN_CHANGE
  SESSION_EXPIRED

  // Family Management
  MEMBER_ADDED
  MEMBER_REMOVED
  MEMBER_UPDATED
  ROLE_CHANGED

  // Chores
  CHORE_COMPLETED
  CHORE_APPROVED
  CHORE_REJECTED
  CHORE_ASSIGNED

  // Credits
  CREDITS_AWARDED
  CREDITS_DEDUCTED
  REWARD_REDEEMED
  REWARD_APPROVED

  // Screen Time
  SCREENTIME_LOGGED
  SCREENTIME_ADJUSTED
  GRACE_PERIOD_USED

  // Routines
  ROUTINE_CREATED
  ROUTINE_UPDATED
  ROUTINE_DELETED
  ROUTINE_COMPLETED

  // Communication
  POST_CREATED
  POST_UPDATED
  POST_DELETED
  POST_PINNED
  POST_UNPINNED

  // Shopping
  SHOPPING_ITEM_ADDED
  SHOPPING_ITEM_UPDATED
  SHOPPING_ITEM_DELETED

  // Settings
  SETTINGS_CHANGED
  MODULE_ENABLED
  MODULE_DISABLED

  // Security
  RATE_LIMIT_HIT
  AUTH_DENIED
  SUSPICIOUS_ACTIVITY
}

enum AuditResult {
  SUCCESS
  FAILURE
  DENIED
}

model AuditLog {
  id            String      @id @default(uuid())
  familyId      String
  memberId      String?
  sessionId     String?
  action        AuditAction
  entityType    String?
  entityId      String?
  previousValue Json?
  newValue      Json?
  metadata      Json?
  ipAddress     String?
  userAgent     String?
  result        AuditResult @default(SUCCESS)
  errorMessage  String?
  createdAt     DateTime    @default(now())
  expiresAt     DateTime?

  // Relations
  family Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)
  member FamilyMember? @relation(fields: [memberId], references: [id], onDelete: SetNull)

  @@index([familyId, action, createdAt])
  @@index([memberId, createdAt])
  @@map("audit_logs")
}

// ============================================
// NOTIFICATIONS MODULE
// ============================================

enum NotificationType {
  CHORE_COMPLETED
  CHORE_APPROVED
  CHORE_REJECTED
  CHORE_ASSIGNED
  REWARD_REQUESTED
  REWARD_APPROVED
  REWARD_REJECTED
  CREDITS_EARNED
  CREDITS_SPENT
  SCREENTIME_ADJUSTED
  SCREENTIME_LOW
  TODO_ASSIGNED
  SHOPPING_REQUEST
  GENERAL
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  actionUrl String?
  metadata  Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  user FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// ============================================
// GAMIFICATION MODULE
// ============================================

enum AchievementCategory {
  CHORES
  CREDITS
  STREAKS
  SOCIAL
  SPECIAL
}

enum BadgeTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

model Achievement {
  id          String              @id @default(uuid())
  key         String              @unique
  name        String
  description String
  category    AchievementCategory
  tier        BadgeTier           @default(BRONZE)
  iconName    String
  requirement Int // e.g., 10 chores, 100 credits
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  userAchievements UserAchievement[]

  @@index([category, tier])
  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  progress      Int      @default(0)
  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user        FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement  @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, isCompleted])
  @@map("user_achievements")
}

enum StreakType {
  DAILY_CHORES
  WEEKLY_CHORES
  PERFECT_WEEK
  REWARD_SAVER
}

model Streak {
  id                String     @id @default(uuid())
  userId            String
  type              StreakType
  currentCount      Int        @default(0)
  longestCount      Int        @default(0)
  lastActivityDate  DateTime?
  isActive          Boolean    @default(true)
  frozenUntil       DateTime? // Streak protection/freeze
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  user FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId, isActive])
  @@map("streaks")
}

model LeaderboardEntry {
  id         String   @id @default(uuid())
  userId     String
  familyId   String
  period     String // "weekly", "monthly", "all-time"
  periodKey  String // "2025-W01", "2025-01", "all-time"
  score      Int      @default(0)
  rank       Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user   FamilyMember @relation(fields: [userId], references: [id], onDelete: Cascade)
  family Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([userId, period, periodKey])
  @@index([familyId, period, periodKey, score])
  @@map("leaderboard_entries")
}

// ============================================
// ALLOWANCE & FINANCIAL TRACKING
// ============================================

model AllowanceSchedule {
  id              String    @id @default(uuid())
  memberId        String
  amount          Int
  frequency       Frequency
  dayOfWeek       Int? // 0-6 for Sunday-Saturday (for WEEKLY, BIWEEKLY)
  dayOfMonth      Int? // 1-28 (for MONTHLY)
  isActive        Boolean   @default(true)
  isPaused        Boolean   @default(false)
  startDate       DateTime  @default(now())
  endDate         DateTime?
  lastProcessedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, isActive])
  @@index([isActive, isPaused, lastProcessedAt])
  @@map("allowance_schedules")
}

model SavingsGoal {
  id            String    @id @default(uuid())
  memberId      String
  name          String
  description   String?
  targetAmount  Int
  currentAmount Int       @default(0)
  iconName      String    @default("currency-dollar")
  color         String    @default("blue")
  deadline      DateTime?
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  member FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId, isCompleted])
  @@map("savings_goals")
}

model Budget {
  id          String           @id @default(uuid())
  memberId    String
  category    SpendingCategory
  limitAmount Int
  period      String // "weekly", "monthly"
  resetDay    Int              @default(0) // 0-6 for Sunday-Saturday
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  member  FamilyMember   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  periods BudgetPeriod[]

  @@unique([memberId, category, period])
  @@index([memberId, isActive])
  @@map("budgets")
}

model BudgetPeriod {
  id          String   @id @default(uuid())
  budgetId    String
  periodKey   String // "2025-W01", "2025-01"
  periodStart DateTime
  periodEnd   DateTime
  spent       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@unique([budgetId, periodKey])
  @@index([budgetId, periodStart])
  @@map("budget_periods")
}

// ============================================
// ROUTINES MODULE
// ============================================

model Routine {
  id          String              @id @default(uuid())
  familyId    String
  name        String
  type        RoutineType
  isWeekday   Boolean             @default(true)
  isWeekend   Boolean             @default(true)
  assignedTo  String?             // Specific child, or null for all
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  family      Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  assignee    FamilyMember?       @relation(fields: [assignedTo], references: [id], onDelete: Cascade)
  steps       RoutineStep[]
  completions RoutineCompletion[]

  @@index([familyId, assignedTo])
  @@map("routines")
}

model RoutineStep {
  id               String   @id @default(uuid())
  routineId        String
  name             String
  icon             String?  // Emoji or icon name
  estimatedMinutes Int?
  sortOrder        Int      @default(0)

  // Relations
  routine Routine @relation(fields: [routineId], references: [id], onDelete: Cascade)

  @@index([routineId, sortOrder])
  @@map("routine_steps")
}

model RoutineCompletion {
  id          String   @id @default(uuid())
  routineId   String
  memberId    String
  completedAt DateTime @default(now())
  date        DateTime // Just the date part for daily tracking

  // Relations
  routine Routine      @relation(fields: [routineId], references: [id], onDelete: Cascade)
  member  FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([routineId, memberId, date])
  @@index([memberId, date])
  @@index([routineId, date])
  @@map("routine_completions")
}

enum RoutineType {
  MORNING
  BEDTIME
  HOMEWORK
  AFTER_SCHOOL
  CUSTOM
}

model CommunicationPost {
  id        String         @id @default(uuid())
  familyId  String
  type      PostType
  title     String?
  content   String
  imageUrl  String?
  isPinned  Boolean        @default(false)
  expiresAt DateTime?
  authorId  String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  family    Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  author    FamilyMember   @relation("PostAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  reactions PostReaction[]

  @@index([familyId, createdAt])
  @@index([familyId, isPinned])
  @@map("communication_posts")
}

model PostReaction {
  id        String   @id @default(uuid())
  postId    String
  memberId  String
  emoji     String
  createdAt DateTime @default(now())

  post   CommunicationPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  member FamilyMember      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([postId, memberId, emoji])
  @@index([postId])
  @@index([memberId])
  @@map("post_reactions")
}

enum PostType {
  ANNOUNCEMENT
  KUDOS
  NOTE
  PHOTO
}
